colabDB <- "dev/colabNet.db"

#' Add authors to the database
#'
#' @param authors A data frame with columns lastName, firstName, initials and collectiveName generated by
#' one of the MeSH functions
#' 
#' @import RSQLite
#' @import dplyr
#'
#' @return Data is inserted into the DB and list of new, modified an unmodified author IDs (auID) is returned
#' @export
#'
dbAddAuthors <- function(authors, colabDB = colabDB){

  myConn = dbConnect(SQLite(), colabDB)

  authors = authors |> select(lastName, firstName, initials) |> distinct()
  authors = authors |> group_by(x = tolower(lastName), initials) |> 
    mutate(tempId = cur_group_id()) |> ungroup() |> select(-x)
  
  authors = tbl(myConn, "authorName") |> full_join(
    authors, by = c("lastName", "firstName", "initials"), copy = TRUE
  ) |> collect()

  unmodified = authors |> group_by(tempId) |> filter(sum(is.na(anID)) == 0) |> ungroup()

  # Authors that are already in the DB, but a new version of the name popped up
  modified = authors |> group_by(tempId) |> filter(!sum(is.na(anID)) %in% c(0, n())) |> ungroup()

  if(nrow(modified) > 0){
    q <- dbExecute(
      myConn,
      "INSERT INTO authorName(auID,lastName,firstName,initials,collectiveName)
      VALUES (?,?,?,?)",
      params = list(modified$auID, modified$lastName, modified$firstName, 
        modified$initials, modified$collectiveName)
    )
  }

  # Authors are not yet in the DB
  new = authors |> group_by(tempId) |> filter(all(is.na(anID))) |> ungroup()
  auID <- integer(0)
  
  if(nrow(new) > 0){
    # Create author IDa
    auID <- dbGetQuery(myConn, "INSERT INTO author(modified) VALUES (?) RETURNING auID",
      params = list(rep(timeStamp(), nrow(new))))
    auID <- auID$auID
    
    q <- dbExecute(
      myConn,
      "INSERT INTO authorName(auID,lastName,firstName,initials,collectiveName)
      VALUES (?,?,?,?)",
      params = list(auID, new$lastName, new$firstName, new$initials, new$collectiveName)
    )
  }
  
  dbDisconnect(myConn)

  return(list(auIDNew = auID, auIDModified = unique(modified$auID), auIDUnmodified = unique(unmodified$auID)))
}

#' Add authors to the database
#'
#' @param authorPublicationInfo List of data frames geneated by ncbi_authorPublicationInfo()
#' 
#' @import RSQLite
#' @import dplyr
#'
#' @return Data is inserted into the DB and list of new, modified an unmodified author IDs (auID) is returned
#' @export
#'
dbAddArticles <- function(authorPublicationInfo, colabDB = colabDB){
  myConn = dbConnect(SQLite(), colabDB)

  ### ADD ARTICLES
  articles = authorPublicationInfo$articles

  # Check which articles are already in the database
  existing <- tbl(myConn, "article") |> filter(!PMID %in% articles$PMID) |> select(arID, PMID) |> collect()
  new <- articles |> filter(!PMID %in% existing$PMID)

  arID <- integer(0)
  if(nrow(new) > 0){
    arID <- dbGetQuery(
      myConn,
      "INSERT INTO article(PMID,title,journal,year,month,day)
      VALUES (?,?,?,?,?,?) RETURNING arID",
      params = list(new$PMID, new$title, new$journal, new$year, new$month, new$day)
    )
  }

  ### ADD AUTHOR INFO
  aInfo <- dbAddAuthors(authorPublicationInfo$coAuthors)

  affiliations = authorPublicationInfo$affiliations
  test <- tbl(myConn, "authorName") |> 
    left_join(authorPublicationInfo$coAuthors, 
      by = c("lastName", "firstName", "initials", "collectiveName"), copy = T, na_matches = "na") |> 
    collect()
  
  # TODO: join the above to the affiliations and start entering data into the DB


  return(list(arIDNew = arID, arIDExisting = existing$arID))
  
}